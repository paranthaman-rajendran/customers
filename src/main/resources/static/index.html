<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Management System</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Customer Management System</h1>
        <div class="header-controls">
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="Search customers by name..."
            />
            <button onclick="searchCustomers()">Search</button>
            <button onclick="loadCustomers()">Show All</button>
          </div>
          <div class="customer-count">
            Total Customers: <span id="customerCount">0</span>
          </div>
        </div>
      </header>

      <main>
        <div class="loading" id="loading" style="display: none">
          <p>Loading customers...</p>
        </div>

        <div class="error" id="error" style="display: none">
          <p id="errorMessage"></p>
        </div>

        <div class="customer-grid" id="customerGrid">
          <!-- Customer cards will be inserted here -->
        </div>

        <div class="no-customers" id="noCustomers" style="display: none">
          <p>No customers found.</p>
        </div>
      </main>

      <!-- Add Customer Modal -->
      <div class="modal" id="addCustomerModal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Add New Customer</h2>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
          <form id="addCustomerForm">
            <div class="form-group">
              <label for="customerName">Name:</label>
              <input type="text" id="customerName" required />
            </div>
            <div class="form-group">
              <label for="customerEmail">Email:</label>
              <input type="email" id="customerEmail" required />
            </div>
            <div class="form-group">
              <label for="customerPhone">Phone:</label>
              <input type="text" id="customerPhone" />
            </div>
            <div class="form-group">
              <label for="customerAddress">Address:</label>
              <textarea id="customerAddress" rows="3"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit">Add Customer</button>
              <button type="button" onclick="closeModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <div class="fab" onclick="showAddCustomerModal()">
        <span>+</span>
      </div>
    </div>

    <script>
      // Global variables
      let customers = [];
      const API_BASE_URL = "/api/customers";

      // Load customers on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadCustomers();
        loadCustomerCount();
      });

      // Load all customers
      async function loadCustomers() {
        showLoading(true);
        hideError();

        try {
          const response = await fetch(API_BASE_URL);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          customers = await response.json();
          displayCustomers(customers);
          loadCustomerCount();
        } catch (error) {
          console.error("Error loading customers:", error);
          showError("Failed to load customers. Please try again.");
        } finally {
          showLoading(false);
        }
      }

      // Display customers in grid
      function displayCustomers(customersToDisplay) {
        const customerGrid = document.getElementById("customerGrid");
        const noCustomers = document.getElementById("noCustomers");

        if (customersToDisplay.length === 0) {
          customerGrid.innerHTML = "";
          noCustomers.style.display = "block";
          return;
        }

        noCustomers.style.display = "none";
        customerGrid.innerHTML = customersToDisplay
          .map(
            (customer) => `
                <div class="customer-card" data-id="${customer.id}">
                    <div class="customer-header">
                        <h3>${escapeHtml(customer.name)}</h3>
                        <div class="customer-actions">
                            <button onclick="editCustomer(${
                              customer.id
                            })" class="edit-btn">Edit</button>
                            <button onclick="deleteCustomer(${
                              customer.id
                            })" class="delete-btn">Delete</button>
                        </div>
                    </div>
                    <div class="customer-details">
                        <p><strong>Email:</strong> ${escapeHtml(
                          customer.email
                        )}</p>
                        <p><strong>Phone:</strong> ${escapeHtml(
                          customer.phone || "N/A"
                        )}</p>
                        <p><strong>Address:</strong> ${escapeHtml(
                          customer.address || "N/A"
                        )}</p>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // Search customers
      async function searchCustomers() {
        const searchTerm = document.getElementById("searchInput").value.trim();

        if (searchTerm === "") {
          loadCustomers();
          return;
        }

        showLoading(true);
        hideError();

        try {
          const response = await fetch(
            `${API_BASE_URL}/search?name=${encodeURIComponent(searchTerm)}`
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const searchResults = await response.json();
          displayCustomers(searchResults);
        } catch (error) {
          console.error("Error searching customers:", error);
          showError("Failed to search customers. Please try again.");
        } finally {
          showLoading(false);
        }
      }

      // Load customer count
      async function loadCustomerCount() {
        try {
          const response = await fetch(`${API_BASE_URL}/count`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const count = await response.json();
          document.getElementById("customerCount").textContent = count;
        } catch (error) {
          console.error("Error loading customer count:", error);
        }
      }

      // Show add customer modal
      function showAddCustomerModal() {
        document.getElementById("addCustomerModal").style.display = "block";
      }

      // Close modal
      function closeModal() {
        document.getElementById("addCustomerModal").style.display = "none";
        document.getElementById("addCustomerForm").reset();
      }

      // Add customer form submission
      document
        .getElementById("addCustomerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const customerData = {
            name: document.getElementById("customerName").value,
            email: document.getElementById("customerEmail").value,
            phone: document.getElementById("customerPhone").value,
            address: document.getElementById("customerAddress").value,
          };

          try {
            const response = await fetch(API_BASE_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(customerData),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            closeModal();
            loadCustomers();
            showSuccess("Customer added successfully!");
          } catch (error) {
            console.error("Error adding customer:", error);
            showError("Failed to add customer. Please try again.");
          }
        });

      // Delete customer
      async function deleteCustomer(customerId) {
        if (!confirm("Are you sure you want to delete this customer?")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/${customerId}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          loadCustomers();
          showSuccess("Customer deleted successfully!");
        } catch (error) {
          console.error("Error deleting customer:", error);
          showError("Failed to delete customer. Please try again.");
        }
      }

      // Edit customer (simplified - just reload for now)
      function editCustomer(customerId) {
        alert(
          `Edit functionality would open a modal for customer ID: ${customerId}`
        );
        // TODO: Implement edit modal
      }

      // Utility functions
      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("error").style.display = "block";
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      function showSuccess(message) {
        // Simple success notification (you can enhance this)
        alert(message);
      }

      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text ? text.replace(/[&<>"']/g, (m) => map[m]) : "";
      }

      // Search on Enter key
      document
        .getElementById("searchInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            searchCustomers();
          }
        });

      // Close modal on outside click
      window.onclick = function (event) {
        const modal = document.getElementById("addCustomerModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
